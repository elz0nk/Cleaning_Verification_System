server.js:

const express = require("express");
const http = require("http");
const session = require("express-session");
const bcrypt = require("bcrypt");
const { Server } = require("socket.io");
const sharedsession = require("express-socket.io-session");
const sqlite3 = require("sqlite3").verbose();
const db = new sqlite3.Database("chat.db");
const app = express();
const server = http.createServer(app);
const io = new Server(server);
const sessionMiddleware = session({
  secret: "clave_secreta",
  resave: false,
  saveUninitialized: false
});

app.use(express.json());
app.use(express.static("public"));
app.use(sessionMiddleware);

io.use(sharedsession(sessionMiddleware, { autoSave: true }));

db.serialize(() => {
  db.run(`
    CREATE TABLE IF NOT EXISTS usuarios (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      usuario TEXT,
      email TEXT UNIQUE,
      password TEXT
    )
  `);

  db.run(`
    CREATE TABLE IF NOT EXISTS mensajes (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      conversacion TEXT,
      de TEXT,
      para TEXT,
      texto TEXT,
      fecha TEXT
    )
  `);

  db.run(`
  CREATE TABLE IF NOT EXISTS casas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    usuario TEXT,
    nombre TEXT,
    direccion TEXT
  )
`);

  db.run(`
  CREATE TABLE IF NOT EXISTS checklist (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    usuario TEXT,
    casa_id INTEGER,
    texto TEXT,
    completado INTEGER
  )
`);

  db.run(`
  CREATE TABLE IF NOT EXISTS contact_forms (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    usuario TEXT,
    name TEXT,
    email TEXT,
    phone TEXT,
    reason TEXT,
    message TEXT,
    newsletter INTEGER,
    fecha TEXT
  )
`);

});

module.exports = db;

// REGISTER
app.post("/register", async (req, res) => {
  const { usuario, email, password } = req.body;
  const hash = await bcrypt.hash(password, 10);

  db.run(
    "INSERT INTO usuarios (usuario, email, password) VALUES (?, ?, ?)",
    [usuario, email, hash],
    err => err ? res.status(400).end() : res.json({ ok: true })
  );
});

// LOGIN
app.post("/login", (req, res) => {
  const { email, password } = req.body;

  db.get(
    "SELECT * FROM usuarios WHERE email = ?",
    [email],
    async (err, user) => {
      if (!user) return res.status(401).end();

      const ok = await bcrypt.compare(password, user.password);
      if (!ok) return res.status(401).end();

      req.session.usuario = user.usuario;
      req.session.plan = user.plan;
      res.json({ ok: true });
    }
  );
});

// SESSION CHECK
app.get("/me", (req, res) => {
  if (!req.session.usuario) return res.status(401).end();
  res.json({ usuario: req.session.usuario });
});

function requireAdmin(req, res, next) {
  if (!req.session.usuario) return res.status(401).end();
  if (req.session.usuario !== "admin") return res.status(403).end();
  next();
}

app.get("/checklist", (req, res) => {
  if (!req.session.usuario) return res.status(401).end();

  db.all(
    "SELECT * FROM checklist WHERE usuario = ?",
    [req.session.usuario],
    (err, rows) => res.json(rows)
  );
});

app.post("/checklist", (req, res) => {
  const { texto } = req.body;
  const usuario = req.session.usuario;

  db.run(
    "INSERT INTO checklist (usuario, texto, completado) VALUES (?, ?, 0)",
    [usuario, texto],
    function () {
      res.json({ id: this.lastID });
    }
  );
});

app.put("/checklist/:id", (req, res) => {
  db.run(
    "UPDATE checklist SET texto = ? WHERE id = ?",
    [req.body.texto, req.params.id],
    () => res.json({ ok: true })
  );
});

app.put("/checklist/:id/completado", (req, res) => {
  db.run(
    "UPDATE checklist SET completado = ? WHERE id = ?",
    [req.body.completado, req.params.id],
    () => res.json({ ok: true })
  );
});

app.delete("/checklist/:id", (req, res) => {
  db.run(
    "DELETE FROM checklist WHERE id = ?",
    [req.params.id],
    () => res.json({ ok: true })
  );
});


// LOGOUT
app.post("/logout", (req, res) => {
  req.session.destroy(err => {
    if (err) return res.status(500).end();
    res.clearCookie("connect.sid");
    res.json({ ok: true });
  });
});

// SOCKET.IO
const usuariosOnline = {};

function getConversacion(a, b) {
  return [a, b].sort().join("|");
}

io.on("connection", socket => {
  const usuario = socket.handshake.session.usuario;
  if (!usuario) return socket.disconnect();

  usuariosOnline[usuario] = socket.id;

  socket.on("abrir_conversacion", otro => {
    const conv = getConversacion(usuario, otro);
    db.all(
      "SELECT * FROM mensajes WHERE conversacion = ? ORDER BY fecha",
      [conv],
      (_, rows) => socket.emit("historial", rows)
    );
  });

  socket.on("mensaje", data => {
    const conv = getConversacion(usuario, data.para);

    const mensaje = {
      conversacion: conv,
      de: usuario,
      para: data.para,
      texto: data.texto,
      fecha: new Date().toISOString()
    };

    db.run(
      "INSERT INTO mensajes (conversacion, de, para, texto, fecha) VALUES (?, ?, ?, ?, ?)",
      Object.values(mensaje)
    );

    const destino = usuariosOnline[mensaje.para];
    if (destino) io.to(destino).emit("mensaje", mensaje);
    socket.emit("mensaje", mensaje);
  });

  socket.on("disconnect", () => {
    delete usuariosOnline[usuario];
  });
});


app.post("/contact", (req, res) => {
  if (!req.session.usuario) return res.status(401).end();
  const usuario = req.session.usuario;
  const {
    name,
    email,
    phone,
    reason,
    message,
    newsletter
  } = req.body;

  db.run(
    `INSERT INTO contact_forms
     (usuario, name, email, phone, reason, message, newsletter, fecha)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
    [
      usuario,
      name,
      email,
      phone,
      reason,
      message,
      newsletter ? 1 : 0,
      new Date().toISOString()
    ],
    err => {
      if (err) {
        console.error("CONTACT INSERT ERROR:", err);
        return res.status(500).json({ error: "DB insert failed" });
      }
      res.json({ ok: true });
    }
  );
});

app.get("/admin/contact", requireAdmin, (req, res) => {
  db.all(
    "SELECT * FROM contact_forms ORDER BY fecha DESC",
    [],
    (err, rows) => res.json(rows)
  );
});

app.get("/admin/contact.html", requireAdmin, (req, res) => {
  res.sendFile(__dirname + "/public/admin/contact.html");
});


app.get("/", (req, res) => {
  res.sendFile(__dirname + "/public/home.html");
});

function limiteCasas(plan) {
  if (plan === "trial") return 1;
  if (plan === "professional") return 5;
  if (plan === "enterprise") return Infinity;
}

app.post("/casas", (req, res) => {

  if (!req.session.usuario) return res.status(401).end();

  const usuario = req.session.usuario;
  const plan = req.session.plan;
  const { nombre, direccion } = req.body;

  db.get(
    "SELECT COUNT(*) as total FROM casas WHERE usuario = ?",
    [usuario],
    (err, row) => {

      const limite = limiteCasas(plan);

      if (row.total >= limite)
        return res.status(403).json({ error: "Límite alcanzado" });

      db.run(
        "INSERT INTO casas (usuario, nombre, direccion) VALUES (?, ?, ?)",
        [usuario, nombre, direccion],
        function () {
          res.json({ id: this.lastID });
        }
      );
    }
  );
});

app.get("/casas", (req, res) => {
  if (!req.session.usuario) return res.status(401).end();

  db.all(
    "SELECT * FROM casas WHERE usuario = ?",
    [req.session.usuario],
    (err, rows) => res.json(rows)
  );
});

app.get("/checklist/:casaId", (req, res) => {

  if (!req.session.usuario) return res.status(401).end();

  db.all(
    "SELECT * FROM checklist WHERE usuario = ? AND casa_id = ?",
    [req.session.usuario, req.params.casaId],
    (err, rows) => res.json(rows)
  );
});

app.post("/checklist/:casaId", (req, res) => {

  const { texto } = req.body;

  db.run(
    "INSERT INTO checklist (usuario, casa_id, texto, completado) VALUES (?, ?, ?, 0)",
    [req.session.usuario, req.params.casaId, texto],
    function () {
      res.json({ id: this.lastID });
    }
  );
});

app.put("/checklist/:id/completado", (req, res) => {
  db.run(
    "UPDATE checklist SET completado = ? WHERE id = ?",
    [req.body.completado, req.params.id],
    () => res.json({ ok: true })
  );
});


server.listen(3000, () => {
  console.log("Servidor en http://localhost:3000");
});

checklist.html:
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Checklist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            display: flex;
            justify-content: center;
            padding-top: 40px;
        }

        .checklist {
            background: white;
            width: 400px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            text-align: center;
        }

        .add-item {
            display: flex;
            gap: 8px;
        }

        .add-item select {
            flex: 1;
            padding: 8px;
        }

        .add-item button {
            padding: 8px 12px;
            cursor: pointer;
        }

        ul {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f1f1f1;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        li.completed span {
            text-decoration: line-through;
            color: gray;
        }

        li span {
            flex: 1;
            cursor: pointer;
        }

        .actions {
            display: flex;
            gap: 6px;
        }

        .actions button {
            cursor: pointer;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
        }

        .complete {
            background: #4caf50;
            color: white;
        }

        .edit {
            background: #2196f3;
            color: white;
        }

        .delete {
            background: #f44336;
            color: white;
        }
    </style>
</head>

<body>

    <div class="checklist">
        <h2>Checklist</h2>

        <div class="add-item">
            <select id="itemSelect">
                <option value="">Select a Task...</option>
                <option value="Tidy up the Living Room">Tidy up the Living Room</option>
                <option value="Tidy up the Kitchen">Tidy up the Kitchen</option>
                <option value="Tidy up the Bathroom">Tidy up the Bathroom</option>
                <option value="Resupply Paper Rolls">Resupply Paper Rolls</option>
                <option value="Resupply Towels">Resupply Towels</option>
                <option value="Tidy up the Bedroom">Tidy up the Bedroom</option>
                <option value="Make the Bed">Make the Bed</option>
                <option value="Tidy up the Terrace">Tidy up the Terrace</option>
                <option value="Tidy up the Office">Tidy up the Office</option>
            </select>
            <button onclick="addItem()">Add</button>
        </div>

        <ul id="list"></ul>
    </div>

    <script>
        const list = document.getElementById("list");
        const select = document.getElementById("itemSelect");

        fetch("/me")
            .then(r => {
                if (!r.ok) {
                    location.href = "/Signin/login.html";
                    throw new Error("No logueado");
                }
                return r.json();
            })
            .then(() => {
                fetch("/checklist")
                    .then(r => {
                        if (!r.ok) throw new Error("No se pudo cargar checklist");
                        return r.json();
                    })
                    .then(items => items.forEach(renderItem));
            });

        // ➕ Añadir item desde select
        function addItem() {
            const text = select.value;
            if (!text) return;

            fetch("/checklist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ texto: text })
            })
                .then(r => {
                    if (!r.ok) throw new Error("Error al añadir item");
                    return r.json();
                })
                .then(data => {
                    renderItem({
                        id: data.id,
                        texto: text,
                        completado: 0
                    });
                    select.value = "";
                })
                .catch(err => console.error(err));
        }

        function renderItem(item) {
            const li = document.createElement("li");
            if (item.completado) li.classList.add("completed");

            const span = document.createElement("span");
            span.textContent = item.texto;

            const actions = document.createElement("div");
            actions.className = "actions";

            // Completar
            const completeBtn = document.createElement("button");
            completeBtn.textContent = "Done";
            completeBtn.className = "complete";
            completeBtn.onclick = () => {
                const estado = li.classList.toggle("completed") ? 1 : 0;
                fetch(`/checklist/${item.id}/completado`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ completado: estado })
                });
            };

            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.className = "edit";
            editBtn.onclick = () => {

                // Lista de opciones disponibles
                const opciones = [
                    "Tidy up the Living Room",
                    "Tidy up the Kitchen",
                    "Tidy up the Bathroom",
                    "Resupply Paper Rolls",
                    "Resupply Towels",
                    "Tidy up the Bedroom",
                    "Make the Bed",
                    "Tidy up the Terrace",
                    "Tidy up the Office"
                    
                ];

                const selectEdit = document.createElement("select");

                // Opción por defecto
                const defaultOption = document.createElement("option");
                defaultOption.textContent = "Selecciona nueva tarea...";
                defaultOption.value = "";
                selectEdit.appendChild(defaultOption);

                opciones.forEach(op => {
                    const option = document.createElement("option");
                    option.value = op;
                    option.textContent = op;

                    // Seleccionar automáticamente la actual
                    if (op === span.textContent) {
                        option.selected = true;
                    }

                    selectEdit.appendChild(option);
                });

                // Reemplazar texto por select
                li.replaceChild(selectEdit, span);

                selectEdit.focus();

                selectEdit.onchange = () => {
                    const nuevo = selectEdit.value;
                    if (!nuevo) return;

                    span.textContent = nuevo;

                    fetch(`/checklist/${item.id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ texto: nuevo })
                    });

                    li.replaceChild(span, selectEdit);
                };
            };


            // Eliminar
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "delete";
            deleteBtn.onclick = () => {
                fetch(`/checklist/${item.id}`, { method: "DELETE" });
                li.remove();
            };

            actions.append(completeBtn, editBtn, deleteBtn);
            li.append(span, actions);
            list.appendChild(li);
        }
    </script>

</body>

</html>

plans.html:

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            color: black;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;

        }

        .grid div {
            background: white;
            padding: 10px;
        }

        .trial, .professional, .enterprise {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .trial .img1,
        .professional .img2,
        .enterprise .img3 {
            width: 20em;
            height: auto;
        }

        .button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }

        header {
            background: #2651a8;
            color: white;
            padding: 30px 20px 40px;
            position: relative;
            text-align: center;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            color: #2651a8;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
        }

        .back-btn:hover {
            background: #e6ecfa;
            color: #1f3f86;
        }

        header h1 {
            margin: 0;
            font-size: 2.4em;
        }

        header p {
            margin-top: 10px;
            font-size: 1.1em;
            opacity: 0.95;
        }

        .trial-btn,
        .professional-btn,
        .enterprise-btn {
            top: 20px;
            left: 20px;
            background-color: #2651a8;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
        }

        .title-trial, .title-pro, .title-ent {
            text-align: center;
            color: #2651a8;
        }

        .div.trial {
            background: white;
            width: 400px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #copyright {
            overflow: hidden;
            padding: 5em 0em;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            background-color: black;
        }

        #copyright p {
            text-align: center;
            font-size: 1em;
            color: rgba(255, 255, 255, 0.3);
        }

        #copyright a {
            text-decoration: none;
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
</head>
<header>
    <a href="/home.html" class="back-btn">Return</a>

    <h1>Our Plans</h1>
    <p>Choose the plan that best fits your needs</p>
</header>

<body>

    <div class="grid">
        <div class="trial">
            <h3 class="title-trial">1 Month Trial</h3>
            <ul>
                <img class="img1" src="images/trial.png">
                <div>1 user</div>
                <div>1 project</div>
                <div>Email support</div>
                <div>Access to basic features</div>
                <div>0$</div>
                <button onclick="window.location.href='signup.html'" class="trial-btn">Create Account</button>
            </ul>
        </div>

        <div class="professional">
            <h3 class="title-pro">Professional Edition</h3>
            <ul>
                <img class="img2" src="images/professional.png">
                <div>Up to 10 users</div>
                <div>Up to 10 projects</div>
                <div>Priority support</div>
                <div>Access to all features</div>
                <div>29$ per month</div>
                <button onclick="window.location.href='proplan.html'" class="professional-btn">Select Plan</button>
            </ul>
        </div>

        <div class="enterprise">
            <h3 class="title-ent">Enterprise Edition</h3>

            <ul>
                <img class="img3" src="images/enterprise.png">
                <div>Unlimited users</div>
                <div>Unlimited projects</div>
                <div>Priority support</div>
                <div>Access to all features</div>
                <div>Contact us for pricing</div>
                <button onclick="window.location.href='contact.html'" class="enterprise-btn">Contact Us</button>
            </ul>
        </div>
    </div>
    <div id="copyright" class="container">
        <p>&copy; Sercom. All rights reserved. | <a href="http://Instagram.com/">Instagram</a> | <a
                href="http://Facebook.com/">Facebook</a> | <a href="http://Whatsapp.com/">Whatsapp</a></p>
    </div>

</body>

</html>

checklist-casa.html:

<h2>Checklist</h2>

<select id="taskSelect">
  <option value="">Selecciona tarea</option>
  <option value="Revisar mensajes">Revisar mensajes</option>
  <option value="Actualizar perfil">Actualizar perfil</option>
</select>

<button onclick="addTask()">Añadir</button>

<ul id="list"></ul>

<script>
const casaId = localStorage.getItem("casaActiva");
const list = document.getElementById("list");

fetch(`/checklist/${casaId}`)
  .then(r => r.json())
  .then(tasks => tasks.forEach(renderTask));

function addTask() {
  const texto = document.getElementById("taskSelect").value;

  fetch(`/checklist/${casaId}`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ texto })
  })
  .then(r => r.json())
  .then(data => renderTask({ id:data.id, texto, completado:0 }));
}

function renderTask(task) {
  const li = document.createElement("li");
  if(task.completado) li.style.textDecoration="line-through";
  li.textContent = task.texto;
  list.appendChild(li);
}
</script>

verif.html:

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification</title>
</head>

<body>

    <!DOCTYPE html>
    <html lang="es">

    <head>
        <meta charset="UTF-8">
        <title>Verification Panel</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <style>
            body {
                font-family: Arial, sans-serif;
                background: #f4f6f8;
                padding: 40px;
            }

            h2 {
                text-align: center;
            }

            .grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
                margin-top: 40px;
            }

            .card {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                text-align: center;
            }

            .card h4 {
                margin-bottom: 15px;
            }

            .verify-btn {
                padding: 8px 14px;
                border: none;
                border-radius: 6px;
                background: #4caf50;
                color: white;
                cursor: pointer;
            }

            .verified {
                background: #ccc;
            }
        </style>
    </head>

    <body>

        <h2>Verification Panel</h2>

        <div class="grid" id="grid"></div>

        <script>
            const grid = document.getElementById("grid");

            // Verificar sesión
            fetch("/me")
                .then(r => {
                    if (!r.ok) {
                        location.href = "/Signin/login.html";
                        throw new Error("No logueado");
                    }
                    return r.json();
                })
                .then(() => {
                    fetch("/checklist")
                        .then(r => {
                            if (!r.ok) throw new Error("Error cargando checklist");
                            return r.json();
                        })
                        .then(tasks => tasks.forEach(renderCard));
                })
                .catch(err => console.error(err));


            function renderCard(task) {

                const card = document.createElement("div");
                card.className = "card";

                const title = document.createElement("h4");
                title.textContent = task.texto;

                const button = document.createElement("button");
                button.className = "verify-btn";

                // Estado inicial según BD
                if (task.completado) {
                    button.textContent = "Verified";
                    button.classList.add("verified");
                    button.disabled = true;
                } else {
                    button.textContent = "Verify";
                }

                button.onclick = () => {

                    fetch(`/checklist/${task.id}/completado`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ completado: 1 })
                    })
                        .then(r => {
                            if (!r.ok) throw new Error("Error actualizando estado");

                            button.textContent = "Verified";
                            button.classList.add("verified");
                            button.disabled = true;
                        })
                        .catch(err => console.error(err));
                };

                card.appendChild(title);
                card.appendChild(button);
                grid.appendChild(card);
            }
        </script>

    </body>

    </html>


</body>

</html>


verif-casa.html:

 <h2>Verificación</h2>

<div id="grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;"></div>

<script>
const casaId = localStorage.getItem("casaActiva");
const grid = document.getElementById("grid");

fetch(`/checklist/${casaId}`)
  .then(r => r.json())
  .then(tasks => tasks.forEach(renderCard));

function renderCard(task) {
  const div = document.createElement("div");
  div.style.border="1px solid #ccc";
  div.style.padding="10px";

  const title = document.createElement("p");
  title.textContent = task.texto;

  const btn = document.createElement("button");

  if(task.completado){
    btn.textContent="Verified";
    btn.disabled=true;
  } else {
    btn.textContent="Verify";
    btn.onclick = () => {
      fetch(`/checklist/${task.id}/completado`,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ completado:1 })
      }).then(()=>{
        btn.textContent="Verified";
        btn.disabled=true;
      });
    };
  }

  div.append(title,btn);
  grid.appendChild(div);
}
</script>